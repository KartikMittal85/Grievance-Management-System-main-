<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Student Dashboard</a>
        <div class="d-flex">
            <!-- Button to open feedback modal -->
            <button class="btn btn-light me-2" data-bs-toggle="modal" data-bs-target="#feedbackModal">Give Feedback</button>
            <a class="btn btn-light" href="{{ url_for('logout') }}">Logout</a>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h4>Submit a Grievance</h4>
    <form method="POST">
        <div class="mb-3">
            <label>Title</label>
            <input type="text" name="title" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Category</label>
            <input type="text" name="category" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>Description</label>
            <textarea name="description" class="form-control" rows="3" required></textarea>
        </div>
        <button class="btn btn-primary">Submit</button>
    </form>

    <hr>
    <h4>Your Grievances</h4>
    <table class="table table-striped" id="grievance_table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Category</th>
                <th>Status</th>
                <th>Remarks</th>
                <th>Last Updated</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Feedback Modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="feedbackForm">
        <div class="modal-header">
          <h5 class="modal-title" id="feedbackModalLabel">Submit Feedback</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="feedbackAlert"></div>
          <div class="mb-3">
            <label>Your Name</label>
            <input type="text" name="name" class="form-control" required value="{{ current_user.username }}">
          </div>
          <div class="mb-3">
            <label>Your Email</label>
            <input type="email" name="email" class="form-control" required value="{{ current_user.username }}@example.com">
          </div>
          <div class="mb-3">
            <label>Feedback</label>
            <textarea name="message" rows="4" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Submit Feedback</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function loadGrievances() {
    $.getJSON('{{ url_for("fetch_grievances") }}', function(data) {
        var tbody = $('#grievance_table tbody');
        tbody.empty();
        data.forEach(function(g) {
            tbody.append('<tr>'+
                '<td>'+g.id+'</td>'+
                '<td>'+g.title+'</td>'+
                '<td>'+g.category+'</td>'+
                '<td>'+g.status+'</td>'+
                '<td>'+g.remarks+'</td>'+
                '<td>'+g.last_updated+'</td>'+
            '</tr>');
        });
    });
}

$(document).ready(function() {
    loadGrievances();
    setInterval(loadGrievances, 5000); // Refresh every 5 seconds

    // AJAX Feedback submission
    $('#feedbackForm').on('submit', function(e) {
        e.preventDefault();
        var formData = $(this).serialize();

        $.post('{{ url_for("feedback") }}', formData, function(response) {
            $('#feedbackAlert').html('<div class="alert alert-success">Thank you for your feedback!</div>');
            $('#feedbackForm')[0].reset();
            setTimeout(function() {
                var modal = bootstrap.Modal.getInstance(document.getElementById('feedbackModal'));
                modal.hide();
                $('#feedbackAlert').html('');
            }, 1500);
        }).fail(function(xhr) {
            var errorMsg = 'An error occurred. Please try again.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            $('#feedbackAlert').html('<div class="alert alert-danger">'+errorMsg+'</div>');
        });
    });
});
</script>
</body>
</html>
